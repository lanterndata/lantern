# Define arguments for the image
ARG VERSION=15
ARG IMAGE_TAG=$VERSION-bookworm

# Base image
FROM postgres:$IMAGE_TAG
ARG VERSION

# Set the working directory in the image
WORKDIR /lanterndb

# Copy the local content into the working directory
COPY . .

# Update and install necessary dependencies
RUN apt update \
    # Fix the locales package version to prevent unexpected updates
    && apt-mark hold locales \
    # Install required packages for build
    && apt install -y --no-install-recommends \
       build-essential \
       cmake \
       postgresql-server-dev-$VERSION \
       postgresql-$VERSION-pgvector \
       gdb \
       wget \
       python3-pip \
       sudo \
       # Install required packages for pgFormatter
       perl \
       make \
       gcc \
       libcgi-pm-perl \
    # Install libtmux using pip
    && pip install libtmux --break-system-packages

# Build lanterndb
RUN rm -rf build \
    && mkdir build \
    && cd build \
    # Run cmake with specific flags and build the project
    && cmake -DUSEARCH_NO_MARCH_NATIVE=ON -DCMAKE_BUILD_TYPE=Debug .. \
    && make install

# Install pgFormatter
ARG PGFORMATTER_VERSION=5.3
RUN wget https://github.com/darold/pgFormatter/archive/refs/tags/v${PGFORMATTER_VERSION}.tar.gz && \
    tar xzf v${PGFORMATTER_VERSION}.tar.gz && \
    cd pgFormatter-${PGFORMATTER_VERSION}/ && \
    perl Makefile.PL && \
    make && make install && \
    cd ../ && rm -rf v${PGFORMATTER_VERSION}.tar.gz && rm -rf pgFormatter-${PGFORMATTER_VERSION}
