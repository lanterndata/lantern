------------------------------------------------------------------------------
-- Test HNSW index creation
------------------------------------------------------------------------------
-- Validate that index creation works with a small number of vectors
\ir utils/small_world_array.sql
CREATE TABLE small_world (
    id SERIAL,
    b BOOLEAN,
    v REAL[2]
);
INSERT INTO small_world (b, v) VALUES
    (TRUE, '{1,1}'),
    (TRUE, '{3,3}'),
    (TRUE, '{2,2}'),
    (TRUE, '{4,4}'),
    (TRUE, '{1,9}');
\ir utils/sift1k_array.sql
CREATE TABLE IF NOT EXISTS sift_base1k (
    id SERIAL PRIMARY KEY,
    v REAL[]
);
COPY sift_base1k (v) FROM '/tmp/lanterndb/vector_datasets/sift_base1k_arrays.csv' WITH csv;
-- Validate that creating a secondary index works
CREATE INDEX ON sift_base1k USING hnsw (v) WITH (dims=128, M=4);
INFO:  done init usearch index
INFO:  inserted 1000 elements
INFO:  done saving 1000 vectors
SELECT ldb_get_indexes('sift_base1k');
                                                           ldb_get_indexes                                                            
--------------------------------------------------------------------------------------------------------------------------------------
 (sift_base1k_pkey,"40 kB","CREATE UNIQUE INDEX sift_base1k_pkey ON public.sift_base1k USING btree (id)","672 kB")
 (sift_base1k_v_idx,"632 kB","CREATE INDEX sift_base1k_v_idx ON public.sift_base1k USING hnsw (v) WITH (dims='128', m='4')","672 kB")
(2 rows)

-- Validate that index creation works with a larger number of vectors
CREATE TABLE sift_base10k (
    id SERIAL PRIMARY KEY,
    v REAL[128]
);
\COPY sift_base10k (v) FROM '/tmp/lanterndb/vector_datasets/siftsmall_base_arrays.csv' WITH CSV;
WARNING:  terminating connection because of crash of another server process
server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.
connection to server was lost
